# PLURTECH API

## Model
Generated by Rails ERD. Run `rake erd` to regenerate (must have graphvis).
![](/erd.png)

TODO:

Users
- Authentication
- Social media account validations

Messages
- from_user_id
- to_user_id
- message
- timestamp
- location
- images,etc
- Last viewed message

## Configuration and System dependencies
- Ubuntu 16.04 LTS
- ruby 2.5.1p57 (2018-03-29 revision 63029) [x86_64-linux]
- Rails 5.2.0
- Graphviz (only for Development Environment)

## Database creation
```
$ rails db:migrate
$ rails db:seed
```

* Database initialization

* How to run the test suite

* Services (job queues, cache servers, search engines, etc.)

## API

### Users

#### View all Users
~~~~
GET /users
~~~~

#### View Individual User
~~~~
GET /users/1
GET /users/2
GET /users/5
~~~~
RESPONSE ON SUCCESS:
{
"id": 5,
"name": "Arlette Dickinson",
"email": "dickinson.arlette@hotmail.com",
"username": "dickinson.arlette",
"profile_picture": null,
"phone": "545-259-2169",
"facebook": "https://www.facebook.com/XXX/",
"snapchat": "",
"twitter": "https://twitter.com/XXXX",
"instagram": "https://www.instagram.com/XXXX/",
"last_online": "2018-07-27T17:22:03.600Z",
"created_at": "2018-07-29T22:12:06.620Z",
"updated_at": "2018-07-29T22:12:06.620Z"
}

RESPONSE ON FAILURE: 404 Not Found


#### Create User

Constraints:
1) username is unique
2) name is between 4 and 70 characters
3) email must be of valid format

~~~
POST /users
~~~

RESPONSE ON SUCCESS:
201 Created

RESPONSE ON FAILURE:
If the same request is sent again, we get an error because the email and username are already taken:

422 Unprocessable Entity
{
"email": ["has already been taken"],
"username": ["has already been taken"],
}

#### Update User

Update any attribute(s). Never attempt to update id, created_at and updated_at attributes:
~~~
PATCH /users/5
{"name":"Dipen Chauhan","email":"get.dipen@gmail.com","username":"dc555"}
~~~
Response:

Head: 200 OK

{
"id": 5,
"name": "Dipen Chauhan",
"email": "get.dipen@gmail.com",
"username": "dc555",
"profile_picture": "https://robohash.org/perspiciatisdoloremenim.png?size=300x300&set=set1",
"phone": "1-223-768-6488",
"facebook": "https://www.facebook.com/frank.reynolds/",
"snapchat": "",
"twitter": "https://twitter.com/frank.reynolds",
"instagram": "https://www.instagram.com/frank.reynolds/",
"last_online": "2018-07-29T03:25:46.112Z",
"created_at": "2018-07-31T00:52:08.792Z",
"updated_at": "2018-07-31T02:21:31.074Z"
}


#### Delete User
~~~
DELETE /users/1
~~~
RESPONSE ON SUCCESS: 204 No Content
RESPONSE ON FAILURE: 404 Not Found


### Friendships

#### View User's Friends
~~~
GET /users/1/friends/index
GET /users/2/friends/index
~~~

#### Add Friend without Friend Request
~~~
POST /users/1/friends
Request Body:
{ "friendship": { "friend_id": "4" } }
~~~

#### Delete Friend

The following will delete user3 from user1's friend list. user3 is user having id 3 and user1 is user having id 1.
~~~
DELETE /users/1/friends/3
~~~
SUCCESS: 204 No Content
FAILURE: 404 Not Found


### Friend Requests

#### View User's Incoming and Outgoing Friend Requests
~~~
GET /users/1/friend_requests
GET /users/2/friend_requests
~~~

#### View Incoming Friend Requests
~~~~
GET /users/1/friend_requests/incoming
~~~~

#### View User's Outgoing Friend Requests
~~~~
GET /users/1/friend_requests/outgoing
~~~~

#### Create Friend Request
~~~
user1 sends a friend request to user4
POST /users/1/friend_requests
{"friend_id":"4"}
~~~

#### Accept Incoming Friend Request
~~~
PATCH /users/1/friend_requests/accept

~~~

#### Cancel Incoming Friend Request

#### Cancel Outgoing Friend Request

### Posts

#### View All User's Posts
~~~~
GET /users/1/posts
~~~~

#### View one of User's Post
~~~~
GET /users/1/posts/1
~~~~

#### Create new Post
~~~
POST /users/1/posts
{"body":"This is a post","has_image":true,"image_url":"https://loremflickr.com/cache/resized/4407_37320651181_594a3c8208_b_800_600_nofilter.jpg"}
~~~

#### Update Post
~~~
PATCH /posts/112
{"body":"This is modified post 4"}
~~~

#### Delete Post
~~~
DELETE /posts/2
~~~

#### View User's Feed
~~~
GET /users/1/feed
~~~


## Easy Development
- Shortcuts to SSH clients - https://askubuntu.com/questions/754450/shortcuts-to-ssh-clients

## Deployment instructions
- Setup Ruby On Rails on Ubuntu 16.04 - https://gorails.com/setup/ubuntu/16.04
- Installing Passenger + Nginx on Ubuntu 16.04 LTS - https://www.phusionpassenger.com/library/install/nginx/install/oss/xenial/
- Deploying a Ruby app on a Linux/Unix production server - https://www.phusionpassenger.com/library/walkthroughs/deploy/ruby/ownserver/nginx/oss/xenial/deploy_app.html
- Deploying application updates - https://www.phusionpassenger.com/library/walkthroughs/deploy/ruby/ownserver/nginx/oss/deploy_updates.html
~~~
git pull
bundle install --deployment --without development test
DISABLE_DATABASE_ENVIRONMENT_CHECK=1 rails db:drop RAILS_ENV=production
rails db:migrate RAILS_ENV=production
rails db:seed RAILS_ENV=production
~~~

## Testing
```bash
# GET    /articles
$curl 0.0.0.0:3000

# POST   /articles
$curl -d '{"title":"test1", "content":"lorem"}' -H "Content-Type: application/json" -X POST http://0.0.0.0:3000/articles

# GET    /articles/:id
$curl 0.0.0.0:3000/articles/1

# PATCH  /articles/:id
$curl -d '{"title":"test5", "content":"lorem5"}' -H "Content-Type: application/json" -X PATCH http://0.0.0.0:3000/articles/5


# PUT    /articles/:id

# DELETE /articles/:id

# https://rubyplus.com/articles/4921-Rails-Forgery-Protection-Basics
# 
curl http://localhost:3000/users/new --cookie-jar "cookie.txt"

# after this command, you will see a authenticity_token, please remember it.

curl http://localhost:3000/users --request POST --cookie-jar "cookie.txt" --cookie "cookie.txt" --data-urlencode "authenticity_token=cOusCzjDwAt6ybUCAICCw9W4Fq9jwOr8Tys7qn8+Sa6F/Pj/d8WzgisX7U6xEUrSUqQSBvi1WpK4GdXUdMoPOA==" --data "user[name]=Foo" --data "user[email]=foobar@gmail.com" --data "user[username]=foobar" --data "user[phone]=123" 

POST /users
curl -i \
-H "Accept: application/json" \
-H "Content-type: application/json" \
-X POST \
-d '{"name":"Dipen Chauhan", "email":"get.dipen@gmail.com", "username":"dipen.chauhan"}' \
http://localhost:3000/users
```

## References
- Mutual friendship in Rails - https://dankim.io/mutual-friendship-rails/
- Friendship fix - https://stackoverflow.com/questions/50614670/activerecordstatementinvalid-sqlite3sqlexception-no-such-table
- Self-Referential Association - http://railscasts.com/episodes/163-self-referential-association
- Faker::Avatar - https://github.com/stympy/faker/blob/master/doc/avatar.md
- Pluck vs select. Pluck takes lesser time but select returns the actual object - http://gavinmiller.io/2013/getting-to-know-pluck-and-select/
- Counter Cache 
	- https://rubyplus.com/articles/3221-Counter-Cache-Column-in-Rails-5
	- https://gorails.com/episodes/counter-caches
